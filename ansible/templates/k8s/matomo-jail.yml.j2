---
apiVersion: v1
kind: ReplicationController
metadata:
  name: {{ matomo_name }}
spec:
  replicas: 1
  selector:
    app: {{ matomo_name }}
  template:
    metadata:
      labels:
        app: {{ matomo_name }}
    spec:
      containers:
      - image: {{ wai_matomo_base_image }}
        name: {{ matomo_name }}
        resources:
          limits:
            cpu: "0.75"
            memory: "250Mi"
        ports:
        - containerPort: 9000
          name: fpm-port
        volumeMounts:
        - name: {{ matomo_name }}-html
          mountPath: /var/www/html
      - image: nginx:1.15.8
        name: nginx
        resources:
          limits:
            cpu: "0.25"
            memory: "128Mi"
        args: ["nginx", "-g", "daemon off;", "-c", "/etc/config/nginx.conf"]
        ports:
        - containerPort: 80
          name: nginx
        volumeMounts:
        - name: {{ matomo_name }}-nginx-conf
          mountPath: /etc/config/
        - name: {{ matomo_name }}-html
          mountPath: /var/www/html
      volumes:
        - name: {{ matomo_name }}-nginx-conf
          configMap: 
            name: {{ matomo_name }}-nginx-conf
        - name: {{ matomo_name }}-html
          emptyDir: {}
---
kind: ConfigMap
apiVersion: v1
metadata:
  name: {{ matomo_name }}-nginx-conf
data:
  nginx.conf: |-
    user nginx;
    worker_processes  1;
    error_log  /var/log/nginx/error.log warn;
    pid        /var/run/nginx.pid;
    events {
      worker_connections 1024;
    }
    http {
      upstream backend {
        server localhost:9000;
      }
      include /etc/nginx/mime.types;
      default_type application/octet-stream;
      gzip on;
      gzip_disable "msie6";    
      server {
        listen 80;
        root /var/www/html/;
        location = {{ matomo_app_filename }} {
          fastcgi_param  GATEWAY_INTERFACE  CGI/1.1;
          fastcgi_param  SERVER_SOFTWARE    nginx;
          fastcgi_param  QUERY_STRING       $query_string;
          fastcgi_param  REQUEST_METHOD     $request_method;
          fastcgi_param  CONTENT_TYPE       $content_type;
          fastcgi_param  CONTENT_LENGTH     $content_length;
          fastcgi_param  SCRIPT_FILENAME    $document_root$fastcgi_script_name;
          fastcgi_param  SCRIPT_NAME        $fastcgi_script_name;
          fastcgi_param  REQUEST_URI        $request_uri;
          fastcgi_param  DOCUMENT_URI       $document_uri;
          fastcgi_param  DOCUMENT_ROOT      $document_root;
          fastcgi_param  SERVER_PROTOCOL    $server_protocol;
          fastcgi_param  REMOTE_ADDR        $remote_addr;
          fastcgi_param  REMOTE_PORT        $remote_port;
          fastcgi_param  SERVER_ADDR        $server_addr;
          fastcgi_param  SERVER_PORT        $server_port;
          fastcgi_param  SERVER_NAME        $server_name;
          fastcgi_intercept_errors on;
          fastcgi_pass backend;
        }
        location ~* {
          deny all;
        }
      }
    }
---
apiVersion: v1
kind: Service
metadata:
  name: {{ matomo_name }}-service
spec:
  ports:
  - name: matomo
    protocol: TCP
    port: 80
  selector:
    app: {{ matomo_name }}
---
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: {{ matomo_name }}
  annotations:
    kubernetes.io/ingress.class: "nginx"
    nginx.ingress.kubernetes.io/affinity: "cookie"
    nginx.ingress.kubernetes.io/session-cookie-name: "route"
    nginx.ingress.kubernetes.io/session-cookie-hash: "sha1"
spec:
  rules:
    # TO FIX
    - host: wai-prod.ingestion.devlab.local
      http:
        paths:
          - path: /
            backend:
              serviceName: {{ matomo_name }}-service
              servicePort: 80    
