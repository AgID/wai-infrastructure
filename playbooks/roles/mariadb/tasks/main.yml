---
# MariaDB installation
- name: MariaDB .:. Install python3-pymysql
  apt: 
    update_cache: true
    name: python3-pymysql
    state: present

- name: MariaDB .:. Test if root .mysql file exists
  stat:
    path: "/root/.my.cnf"
  register: mariadb_mycnf_result

- name: MariaDB .:. Test if data has been moved
  stat:
    path: "/opt/data/mysql/ibdata1"
  register: mariadb_data_moved

- name: MariaDB .:. Clean mariadb root password if present
  file:
    state: absent
    path: "/root/.my.cnf"
  when: mariadb_mycnf_result.stat.exists == false

- name: MariaDB .:. Install MariaDB
  apt: 
    update_cache: false
    name: mariadb-server
    state: present
  when: mariadb_mycnf_result.stat.exists == false

# Ubuntu configure MariaDB to start using socket
- name: MariaDB .:. Set root password
  mysql_user:
    login_user: 'root'
    name: root
    password: '{{mariadb_root_password}}'
    login_unix_socket: /var/run/mysqld/mysqld.sock
  when: mariadb_mycnf_result.stat.exists == false

- name: MariaDB .:. Configure bind address
  replace:
      path: /etc/mysql/mariadb.conf.d/50-server.cnf
      regexp: "^bind-address.*"
      replace: "bind-address={{hostvars[inventory_hostname]['ansible_default_ipv4']['address']}}"
  when: mariadb_mycnf_result.stat.exists == false

- name: MariaDB .:. Copy mysql data directory to storage device
  raw: 'cp -R -p /var/lib/mysql /opt/data/mysql && rm -fR /var/lib/mysql'
  when: 
    - mariadb_mycnf_result.stat.exists == false
    - mariadb_data_moved.stat.exists == false

- name: MariaDB .:. Change mysql data directory
  replace:
      path: /etc/mysql/mariadb.conf.d/50-server.cnf
      regexp: "^datadir.*"
      replace: "datadir = /opt/data/mysql"
  when: 
    - mariadb_mycnf_result.stat.exists == false
    - mariadb_data_moved.stat.exists == false

- name: MariaDB .:. Restart always mariadb 
  service:
    name: mariadb
    state: restarted
    enabled: yes
  when: 
    - mariadb_mycnf_result.stat.exists == false

- name: MariaDB .:. Create root configuration file
  template:
    src: 'root-my.cnf.j2'
    dest: '/root/.my.cnf'
    owner: 'root'
    group: 'root'
    mode: '0600'
  when:
    - mariadb_mycnf_result.stat.exists == false
