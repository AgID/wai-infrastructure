---
# Galera role
- name: Galera .:. Fail if galera members are less than 3
  fail:
      msg: "Wrong configuration for galera cluster member"
  when: "groups[group_names[0]] | length < 3"

- name: Galera .:. Test if galera has been configured
  stat:
      path: "/etc/mysql/conf.d/galera.cnf"
  register: galera_present_result

- include_role:
      name: mariadb
  when: galera_present_result.stat.exists == false

- name: Create Galera configuration file
  template:
      src: "galera.yml.j2"
      dest: "/etc/mysql/conf.d/galera.cnf"
      owner: "root"
      group: "root"
      mode: "0644"
  when: galera_present_result.stat.exists == false

- name: Identify first Galera node
  set_fact:
      galera_first_node: true
  with_items: ["galera-prod", "galera-play"]
  when: 
    - groups[item]|length > 0
    - inventory_hostname == groups[item][0]

- name: Stop Mariadb
  service:
      name: mariadb
      state: stopped
      enabled: yes
  when: galera_present_result.stat.exists == false

- name: Action on first galera node
  raw: "galera_new_cluster"
  when:
      - "galera_first_node is defined"
      - "galera_present_result.stat.exists == false"

- name: Restart mariadb on other nodes
  service:
      name: mariadb
      state: restarted
      enabled: yes
  when:
      - "galera_first_node is not defined"
      - "galera_present_result.stat.exists == false"
